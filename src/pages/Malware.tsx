import { useState } from 'react';
import { useTauri } from '../hooks/useTauri';
import type { MalwareResult } from '../types';
import { motion } from 'framer-motion';
import { Shield, CheckCircle, AlertTriangle } from 'lucide-react';
import { playCompletionSound } from '../utils/sounds';

export function MalwareAndPrivacy() {
    const { call } = useTauri();
    const [scanning, setScanning] = useState(false);
    const [result, setResult] = useState<MalwareResult | null>(null);

    const startScan = async () => {
        setScanning(true);
        setResult(null);
        try {
            const res = await call<MalwareResult>('scan_malware_command');
            setResult(res);
            playCompletionSound();
        } catch (e) {
            console.error(e);
        } finally {
            setScanning(false);
        }
    };

    // Pre-scan state
    if (!scanning && !result) {
        return (
            <div className="h-full flex flex-col items-center justify-center p-10 text-center">
                <div className="w-32 h-32 rounded-full bg-gradient-to-br from-blue-400 to-indigo-600 flex items-center justify-center mb-8 shadow-2xl shadow-blue-500/30">
                    <Shield className="w-16 h-16 text-white/90" strokeWidth={1.5} />
                </div>

                <h2 className="text-3xl font-bold mb-3">Malware Removal</h2>
                <p className="text-white/50 mb-10 max-w-md leading-relaxed">
                    Scan your System for malware, viruses, and other vulnerabilities.
                </p>

                <div className="space-y-4 mb-10 max-w-md w-full">
                    <div className="flex items-start gap-4 text-left">
                        <div className="w-10 h-10 rounded-xl bg-blue-500/10 border border-blue-500/20 flex items-center justify-center shrink-0">
                            <Shield size={18} className="text-blue-400" />
                        </div>
                        <div>
                            <p className="font-medium text-white/90">Real-time protection</p>
                            <p className="text-sm text-white/40">Scans known threat signatures and suspicious file behavior.</p>
                        </div>
                    </div>
                    <div className="flex items-start gap-4 text-left">
                        <div className="w-10 h-10 rounded-xl bg-blue-500/10 border border-blue-500/20 flex items-center justify-center shrink-0">
                            <CheckCircle size={18} className="text-blue-400" />
                        </div>
                        <div>
                            <p className="font-medium text-white/90">Deep system scan</p>
                            <p className="text-sm text-white/40">Checks launch agents, login items, and system extensions.</p>
                        </div>
                    </div>
                </div>

                <button
                    onClick={startScan}
                    className="w-16 h-16 rounded-full border-2 border-blue-400/50 bg-blue-500/10 hover:bg-blue-500/20 hover:border-blue-400 transition-all duration-300 flex items-center justify-center group shadow-lg shadow-blue-500/10"
                >
                    <span className="text-sm font-semibold text-blue-300 group-hover:text-blue-200">Scan</span>
                </button>
            </div>
        );
    }

    // Scanning state
    if (scanning) {
        return (
            <div className="h-full flex flex-col items-center justify-center">
                <div className="relative mb-8">
                    <div className="w-28 h-28 rounded-full bg-gradient-to-br from-blue-400 to-indigo-600 flex items-center justify-center shadow-2xl shadow-blue-500/30">
                        <Shield className="w-14 h-14 text-white/90" strokeWidth={1.5} />
                    </div>
                    <motion.div
                        className="absolute inset-[-8px] border-2 border-blue-400/30 rounded-full"
                        animate={{ scale: [1, 1.15, 1], opacity: [0.5, 0, 0.5] }}
                        transition={{ duration: 2, repeat: Infinity }}
                    />
                    <motion.div
                        className="absolute inset-[-16px] border border-blue-400/20 rounded-full"
                        animate={{ scale: [1, 1.1, 1], opacity: [0.3, 0, 0.3] }}
                        transition={{ duration: 2, repeat: Infinity, delay: 0.5 }}
                    />
                </div>
                <p className="text-lg font-medium text-white/80">Scanning for threats...</p>
                <p className="text-sm text-white/40 mt-1">Checking system files and applications</p>
            </div>
        );
    }

    // Results state
    const isClean = result!.threats_found.length === 0;
    return (
        <div className="h-full flex flex-col items-center justify-center p-10 text-center">
            <div className={`w-28 h-28 rounded-full flex items-center justify-center mb-8 shadow-2xl ${isClean
                ? 'bg-gradient-to-br from-emerald-400 to-green-600 shadow-emerald-500/30'
                : 'bg-gradient-to-br from-red-400 to-rose-600 shadow-red-500/30'
                }`}>
                {isClean
                    ? <CheckCircle className="w-14 h-14 text-white" />
                    : <AlertTriangle className="w-14 h-14 text-white" />
                }
            </div>

            <h2 className="text-3xl font-bold mb-2">
                {isClean ? 'No Threats Found' : 'Threats Detected'}
            </h2>
            <p className="text-white/50 mb-6">{result!.status}</p>

            {!isClean && (
                <div className="bg-red-500/10 border border-red-500/20 rounded-xl p-4 mb-6 max-w-sm">
                    {result!.threats_found.map((t, i) => (
                        <p key={i} className="text-sm text-red-300">{t}</p>
                    ))}
                </div>
            )}

            <button
                onClick={() => { setResult(null); }}
                className="w-16 h-16 rounded-full border-2 border-blue-400/50 bg-blue-500/10 hover:bg-blue-500/20 hover:border-blue-400 transition-all duration-300 flex items-center justify-center group shadow-lg shadow-blue-500/10"
            >
                <span className="text-xs font-semibold text-blue-300 group-hover:text-blue-200">Rescan</span>
            </button>
        </div>
    );
}
